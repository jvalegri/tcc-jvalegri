generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  email           String           @unique
  password        String
  name            String?
  projects        Project[]        @relation("UserProjects")
  movementRecords MovementRecord[]
}

model Material {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  type            String?
  currentQuantity Int
  unit            String
  isConsumable    Boolean          @default(false)
  movementRecords MovementRecord[]

  // Opposite relation for the many-to-many relationship with Project
  projects        ProjectMaterial[]
}

model Project {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  owner           User             @relation("UserProjects", fields: [ownerId], references: [id])
  ownerId         String           @db.ObjectId
  materials       ProjectMaterial[] // Use explicit relation table
  movementRecords MovementRecord[]
}

model MovementRecord {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  quantity        Int
  timestamp       DateTime @default(now())
  type            String   // 'entry' or 'exit'
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id])
  materialId      String   @db.ObjectId
  material        Material @relation(fields: [materialId], references: [id])
  projectId       String   @db.ObjectId
  project         Project  @relation(fields: [projectId], references: [id])
}

// Explicit many-to-many relationship for Project and Material
model ProjectMaterial {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId   String   @db.ObjectId
  materialId  String   @db.ObjectId
  project     Project  @relation(fields: [projectId], references: [id])
  material    Material @relation(fields: [materialId], references: [id])

  @@unique([projectId, materialId]) // Unique constraint to ensure no duplicates
}
